---
title: 토스페이
description: 토스페이 간편결제 결제창 연동가이드를 확인 합니다.
---

import Tabs from "~/components/gitbook/tabs/Tabs.astro";
import Tab from "~/components/gitbook/tabs/Tab.astro";

## 토스페이-신모듈 PG 설정하기

- **[토스페이-신모듈 설정](../../ready/2-pg/pg/tosspay-v2)** 페이지의 내용을 참고하여 PG 설정을 진행합니다.

## 가능한 결제 수단

- 간편 결제
  - `payMethod`(결제) 혹은 `billingKeyMethod`(빌링키 발급) 파라미터를 `EASY_PAY` 로 설정해야 합니다.
  - 결제창 내에서 카드, 계좌이체, 충전식 머니 선택이 가능합니다.

### SDK 결제 및 빌링키 발급 요청하기

결제 요청 시에는 `requestPayment` 함수를 호출하고, 빌링키 발급 시에는 `requestIssueBillingKey` 함수를 호출해야합니다.
`channelKey` 파라미터에 결제 채널 연동 시 생성된 채널 키값을 지정하여 토스페이-신모듈 연동임을 명시해주세요.
만약 `channelKey`가 입력되지 않는 경우 `pgProvider` 파라미터에 입력된 값에 따라 결제창이 호출됩니다.

토스페이-신모듈 기준으로 작성한 예시 코드는 아래와 같습니다.

<Tabs>
  <Tab title="SDK 결제 요청">
    TODO
  </Tab>

  <Tab title="SDK 빌링키 발급 요청">
    ```javascript
    import * as PortOne from '@portone/browser-sdk/v2';
    function requestIssueBillingKey() {
      PortOne.requestIssueBillingKey({
        storeId: 'store-4ff4af41-85e3-4559-8eb8-***********', // 고객사 storeId로 변경해주세요.
        channelKey: 'channel-key-3b37819a-1c72-4deb-a245-***********', // 콘솔 결제 연동 화면에서 채널 연동 시 생성된 채널 키를 입력해주세요.
        billingKeyMethod : 'EASY_PAY',
        issueName: 'test',
        customer: {
          customerId: 'customerId_1703080411021'
        },
        redirectUrl: 'http://localhost'
      });
    }
    ```
  </Tab>
</Tabs>

#### 주요 파라미터

<Tabs>
  <Tab title="SDK 결제 주요 파라미터">
    TODO
  </Tab>

  <Tab title="SDK 빌링키 발급 주요 파라미터">
    - `storeId` <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>
      - 고객사의 상점을 식별하는 고유한 값입니다.
    - `channelKey` <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>
      - 콘솔의 결제 연동 메뉴에 표시되는 채널 키를 입력해야 합니다.
    - `billingKeyMethod` <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>
      - `EASY_PAY` 로 설정해야 합니다
    - `issueName` <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>
      - 빌링키 발급에 사용되는 주문명입니다.
      - 토스페이의 경우 필수 입력입니다.
    - `customer.customerId` <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>
      - 고객사에서 관리하는 고객 고유번호입니다.
  </Tab>
</Tabs>

#### 유의할 파라미터

<Tabs>
  <Tab title="SDK 결제 유의할 파라미터">
    TODO
  </Tab>

  <Tab title="SDK 빌링키 발급 유의할 파라미터">
    - `redirectUrl` <mark style="color:green;">**string**</mark>
      - 빌링키 발급 후 이동할 URL입니다.
      - 모바일 환경의 경우 필수 입력입니다.
  </Tab>
</Tabs>

### API 예약/반복 결제 요청하기
발급된 빌링키로 예약/반복 결제를 하기위해 `POST /schedules` 를 이용하여 결제를 예약합니다.

```javascript
const response = await axios({
  url: `https://api.portone.io/payments/${PAYMENT_ID_HERE}/schedule`,
  method: "post",
  headers: { Authorization: "Bearer " + access_token },
  data: {
    payment: {
      billingKey: 'billing-key-1', // 빌링키 발급 API를 통해 발급받은 빌링키
      orderName: '월간 이용권 정기결제',
      customer: {
        id: 'customer-1234', // 고객사에서 관리하는 고객 고유번호
      },
      amount: {
        total: 10000,
        taxFree: 500,
      },
      currency: 'KRW',
      useFreeInterestFromMerchant: true, // 고객사 분담 무이자 설정
      InstallmentMonth: 3, // 카드 할부 개월수
      useCardPoint: true, // 카드 포인트 사용 설정
    },
    timeToPay: '2023-01-01T00:00:00+09:00', // 결제를 시도할 시각
  },
});
```

#### API 예약/반복 결제 주요 파라미터
- `paymentId` <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>
  - 고객사에서 채번하는 주문 고유 번호로 매번 고유하게 채번되어야 하며, URL path에 포함돼야 합니다.
- `payment` <mark style="color:red;">**\***</mark> <mark style="color:blue;">**object**</mark>
  - 결제 정보를 담고있는 객체입니다.
  - `bilingKey` <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>
    - 결제를 진행할 빌링키
  - `orderName` <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>
    - 주문명
  - `amount` <mark style="color:red;">**\***</mark> <mark style="color:blue;">**object**</mark>
    - 결제 금액에 대한 정보를 담고있는 객체입니다.
    - `total` <mark style="color:red;">**\***</mark> <mark style="color:purple;">**number**</mark>
      - 결제 금액으로 결제를 원하는 통화(currency)별 scale factor(소수점 몇번째 자리까지 유효한지)를 고려한 number 형식만 허용됩니다.
    - `taxFree` <mark style="color:purple;">**number**</mark>
      - 면세 금액으로 (신)나이스페이먼츠과 상점아이디 계약시 지정금액 혹은 복합과세 방식으로 계약한 경우 면세 처리를 위해 면세금액을 반드시 입력해야 합니다.
        면세금액 미 입력 시 면세금액은 0원으로 자동 처리되며, 결제 요청 금액은 모두 과세 처리 되오니 이 점 유의하시기 바랍니다.
  - `currency` <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>
    - 결제통화로 원화 결제를 원할 시 `KRW`로 입력해야 합니다. (신)나이스페이먼츠의 경우 빌링키로 결제시 `KRW`만 지원합니다.
- `timeToPay` <mark style="color:red;">**\***</mark> <mark style="color:green;">**string**</mark>
  - 결제를 시도할 시각으로 ISO 8601 형식으로 입력해야 합니다.

### 연동 유의사항

#### 토스페이와 사전 계약이 필요한 경우

아래 기능을 사용하시려면 토스페이에 사전 신청 후 계약이 완료되어야 합니다.
* 빌링키 결제

#### 일반결제

- 토스페이의 경우 test API key 를 이용시 현금영수증 발급에 관련된 처리가 불가능합니다. 현금영수증 테스트가 필요한 경우, live API key 를 이용하여 테스트해야합니다.

- 신용카드 결제건만 매출전표 확인이 가능합니다.

- bypass.tosspay_v2.expiredTime 필드가 유효하지 않은값인 경우, 토스페이의 기본값인 15분으로 적용됩니다.

- bypass.tosspay_v2.expiredTime 이전에 유저의 결제 인증이 이루어진 경우, 결제 인증 이후 승인 호출은 expiredTime과 관계없이 3~5분의 별도 만료시간을 가집니다.

#### 빌링키 발급

- 토스페이 빌링키 발급시 빌링키 발급 웹훅을 반드시 연동하는 것이 좋습니다. 콘솔에서 웹훅 URL을 설정하거나, `requestIssueBillingKey` 함수 파라미터 중 noticeUrls를 입력하여 웹훅을 전달받을 수 있습니다.
만약 웹훅을 연동하지 않은 경우, 엔드유저가 빌링키 발급 도중 팝업이나 브라우저를 끄는 행위등으로 인해 고객사의 SDK 콜백 코드가 실행되지 않아 실제로 빌링키가 발급됐으나 발급정보가 누락될 수 있습니다.

- 빌링키가 발급된후에 토스페이앱에서 엔드유저가 직접 빌링키에 연결된 결제수단을 변경할 수 있습니다. 콘솔에 웹훅 URL을 설정해 둔 경우라면 이 때 빌링키 업데이트 웹훅이 전송됩니다.
만약 빌링키에 연결된 결제수단을 서비스 내부적으로 사용하고 있다면, 빌링키 업데이트 웹훅을 연동하시거나 정보를 표시하기 전 포트원의 빌링키 정보 조회 API를 호출하여 데이터를 최신화하기를 권장합니다.

#### 결제 취소

- 부가세를 직접 지정한 결제를 부분 취소 요청하는 경우 취소 금액의 부가세를 입력해야 합니다. 만약 부분 취소 요청 시 부가세를 입력하지 않는 경우 남은 결제금액의 부가세, 과세금액 정보가 올바르지 않게 될 수 있으며 이후 추가 부분취소 요청 시 취소 가능 과세금액 계산 오류로 취소 요청이 불가능할 수 있습니다.
